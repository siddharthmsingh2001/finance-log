name: 05 - Deploy Frontend Infrastructure

env:
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: us-east-1

on:
  workflow_dispatch:
    inputs:
      environmentName:
        description: "Deployment environment (dev, staging, prod)"
        type: choice
        required: true
        default: dev
        options: [dev, staging, prod]
      sslCertificateArnFrontend:
        description: "ACM cert ARN (us-east-1)"
        required: true

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - name: Deploy frontend infra
        working-directory: infrastructure
        run: |
          npm install
          npm run frontend:deploy -- \
            -c environmentName=${{ github.event.inputs.environmentName }} \
            -c region=us-east-1 \
            -c applicationName=finance-log \
            -c accountId=${{ env.AWS_ACCOUNT_ID }} \
            -c sslCertificateArnFrontend=${{ github.event.inputs.sslCertificateArnFrontend }}

      - name: Get CloudFront ID from SSM
        id: fetch-params
        run: |
          PARAM_NAME="${{ github.event.inputs.environmentName }}-frontend-cloudFrontDistributionId"
          
          echo "Fetching parameter: $PARAM_NAME"
          DIST_ID=$(aws ssm get-parameter --name "$PARAM_NAME" --query "Parameter.Value" --output text)
          
          if [ -z "$DIST_ID" ]; then
            echo "Error: Could not find Distribution ID in SSM"
            exit 1
          fi
          
          echo "DISTRIBUTION_ID=$DIST_ID" >> $GITHUB_ENV

      - name: Upload assets to S3
        run: |
          # Pattern based on your Java: bucketName(applicationEnvironment.prefix("frontend-assets"))
          BUCKET_NAME="${{ github.event.inputs.environmentName }}-finance-log-frontend-assets"
          
          aws s3 sync frontend/dist s3://$BUCKET_NAME \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "index.html"

          aws s3 cp frontend/dist/index.html s3://$BUCKET_NAME/index.html \
            --cache-control "no-cache"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ env.DISTRIBUTION_ID }} \
            --paths "/*"